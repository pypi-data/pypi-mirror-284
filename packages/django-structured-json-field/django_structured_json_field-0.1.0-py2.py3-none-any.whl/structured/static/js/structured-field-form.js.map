{"version":3,"file":"structured-field-form.js","sources":["../../../reactive-forms/callbacks.js","../../../reactive-forms/patches.js","../../../reactive-forms/main.js"],"sourcesContent":["export function initCallbacks() {\n    window.JSONEditor.defaults.callbacks = {\n        \"select2\": {\n            \"createQueryParams\": function (_editor, params) {\n                return {\n                  _q: params.term, // search term\n                  page: params.page\n                };\n              },\n            \"processResultData\": function (_editor, data, params) {\n                return {\n                    results: data.map(item =>  ({id: item.id, text: item.name})),\n                    pagination: {\n                        more: false\n                    }\n                };\n              },\n        }\n    };\n}\n","export function patchSelect2Editor() {\n    window.JSONEditor.defaults.editors.select2 = class extends window.JSONEditor.defaults.editors.select2 {\n        preBuild() {\n            if (this.schema.type === \"relation\") {\n                this.schema.enum = []\n            }\n            super.preBuild()\n        }\n\n        async fetchDataFromAPI(value) {\n            value = Array.isArray(value) ? value.join(\",\") : value\n            const url = `${this.options.select2.ajax.url}?_q=_pk__in=${value}`\n            return await fetch(url).then(res => res.json()).catch(_ => [])\n        }\n\n        forceAddOption(value, text) {\n            if (this.enum_values.includes(value)) return\n            this.enum_values.push(value)\n            this.enum_options.push(value)\n            this.enum_display.push(text)\n            this.theme.setSelectOptions(this.input, this.enum_options, this.enum_display)\n        }\n\n        setValue(value, initial) {\n            if (this.schema.type === \"relation\") {\n                if (this.schema.multiple && Array.isArray(value)) {\n                    if (!value.length) return\n                    if (value.every(val => !isNaN(val))) {\n                        value = value.map(id => ({ id }))\n                    }\n                    return this.fetchDataFromAPI(value.map(({ id }) => id)).then(data => {\n                        data.forEach(({ id, name }) => { this.forceAddOption(this.typecast(id), name) })\n                        super.setValue(value.map(({ id }) => this.typecast(id)), initial)\n                    })\n                }\n                if (value?.id) {\n                    let { id, name } = value\n                    id = this.typecast(id)\n                    this.forceAddOption(id, name)\n                    return super.setValue(id, initial)\n                }\n                if (value && !this.enum_values.includes(value)) {\n                    return this.fetchDataFromAPI(value).then(data => {\n                        let { id, name } = data[0] || {}\n                        if (!id) return super.setValue(id, initial)\n                        id = this.typecast(id)\n                        this.forceAddOption(id, name)\n                        super.setValue(id, initial)\n                    })\n                }\n            }\n            super.setValue(value, initial)\n        }\n\n        typecast(value) {\n            if (value && this.schema.type === \"relation\") {\n                return this.schema.multiple ? parseInt(value) : value\n            }\n            return super.typecast(value)\n        }\n\n        updateValue(value) {\n            if (this.schema.type === \"relation\") {\n                if (this.schema.multiple && Array.isArray(value)) {\n                    value = value.map(val => this.innerUpdateCast(val))\n                    this.value = value\n                    return value\n                }\n            }\n            return super.updateValue(value)\n        }\n\n        getValue() {\n            if (this.schema.type === \"relation\") {\n                if (!this.dependenciesFulfilled) {\n                    return undefined\n                }\n                if (this.schema.multiple) {\n                    return this.value?.map(val => this.typecast(val)) || []\n                }\n                return this.typecast(this.value)\n            }\n            return super.getValue()\n        }\n\n        innerUpdateCast(value) {\n            let sanitized = this.enum_values[0]\n            value = this.typecast(value || '')\n            if (!this.enum_values.includes(value)) {\n                if (this.newEnumAllowed) {\n                    sanitized = this.addNewOption(value) ? value : sanitized\n                }\n            } else sanitized = value\n            return sanitized\n        }\n\n        afterInputReady() {\n            super.afterInputReady()\n            if (this.schema.type === \"relation\") {\n                this.newEnumAllowed = true\n                this.control?.querySelector('.select2-container')?.removeAttribute('style')\n            }\n        }\n    }\n    window.JSONEditor.defaults.resolvers.unshift(function (schema) {\n        if (schema.type === \"relation\" && schema.format === \"select2\") {\n            return \"select2\"\n        }\n    })\n}\n","import './scss/main.scss';\nimport { initCallbacks } from './callbacks';\nimport { patchSelect2Editor } from './patches';\n\nfunction renderForm(element) {\n    const schema = JSON.parse(element.dataset.schema);\n    console.log(\"🧱 schema\", schema)\n    const uiSchema = JSON.parse(element.dataset.uischema);\n    const formData = JSON.parse(element.dataset.formdata);\n    console.log(\"🫐 formData\", formData)\n    const inputTextArea = document.getElementById(`id_${element.dataset.name}`);\n    const editor = new JSONEditor(element, { \n        schema,\n        startval: formData,\n        max_depth: 10,\n        show_errors: 'always',\n    });\n    editor.on('change', () => {\n        inputTextArea.innerHTML = JSON.stringify(editor.getValue());\n    });\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n    JSONEditor.defaults.options.theme = 'html';\n    JSONEditor.defaults.options.iconlib = 'fontawesome5';\n    initCallbacks();\n    patchSelect2Editor();\n    const elements = document.querySelectorAll('.structured-field-editor');\n    for (let i = 0; i < elements.length; i++) {\n        renderForm(elements[i]);\n    }\n});"],"names":[],"mappings":"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"}