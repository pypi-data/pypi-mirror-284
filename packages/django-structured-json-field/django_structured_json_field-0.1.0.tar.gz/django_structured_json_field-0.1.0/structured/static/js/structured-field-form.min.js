!function(){"use strict";function e(e){const t=JSON.parse(e.dataset.schema);console.log("🧱 schema",t),JSON.parse(e.dataset.uischema);const s=JSON.parse(e.dataset.formdata);console.log("🫐 formData",s);const a=document.getElementById(`id_${e.dataset.name}`),i=new JSONEditor(e,{schema:t,startval:s,max_depth:10,show_errors:"always"});i.on("change",(()=>{a.innerHTML=JSON.stringify(i.getValue())}))}document.addEventListener("DOMContentLoaded",(()=>{JSONEditor.defaults.options.theme="html",JSONEditor.defaults.options.iconlib="fontawesome5",window.JSONEditor.defaults.callbacks={select2:{createQueryParams:function(e,t){return{_q:t.term,page:t.page}},processResultData:function(e,t,s){return{results:t.map((e=>({id:e.id,text:e.name}))),pagination:{more:!1}}}}},window.JSONEditor.defaults.editors.select2=class extends window.JSONEditor.defaults.editors.select2{preBuild(){"relation"===this.schema.type&&(this.schema.enum=[]),super.preBuild()}async fetchDataFromAPI(e){e=Array.isArray(e)?e.join(","):e;const t=`${this.options.select2.ajax.url}?_q=_pk__in=${e}`;return await fetch(t).then((e=>e.json())).catch((e=>[]))}forceAddOption(e,t){this.enum_values.includes(e)||(this.enum_values.push(e),this.enum_options.push(e),this.enum_display.push(t),this.theme.setSelectOptions(this.input,this.enum_options,this.enum_display))}setValue(e,t){if("relation"===this.schema.type){if(this.schema.multiple&&Array.isArray(e)){if(!e.length)return;return e.every((e=>!isNaN(e)))&&(e=e.map((e=>({id:e})))),this.fetchDataFromAPI(e.map((({id:e})=>e))).then((s=>{s.forEach((({id:e,name:t})=>{this.forceAddOption(this.typecast(e),t)})),super.setValue(e.map((({id:e})=>this.typecast(e))),t)}))}if(e?.id){let{id:s,name:a}=e;return s=this.typecast(s),this.forceAddOption(s,a),super.setValue(s,t)}if(e&&!this.enum_values.includes(e))return this.fetchDataFromAPI(e).then((e=>{let{id:s,name:a}=e[0]||{};if(!s)return super.setValue(s,t);s=this.typecast(s),this.forceAddOption(s,a),super.setValue(s,t)}))}super.setValue(e,t)}typecast(e){return e&&"relation"===this.schema.type?this.schema.multiple?parseInt(e):e:super.typecast(e)}updateValue(e){return"relation"===this.schema.type&&this.schema.multiple&&Array.isArray(e)?(e=e.map((e=>this.innerUpdateCast(e))),this.value=e,e):super.updateValue(e)}getValue(){if("relation"===this.schema.type){if(!this.dependenciesFulfilled)return;return this.schema.multiple?this.value?.map((e=>this.typecast(e)))||[]:this.typecast(this.value)}return super.getValue()}innerUpdateCast(e){let t=this.enum_values[0];return e=this.typecast(e||""),this.enum_values.includes(e)?t=e:this.newEnumAllowed&&(t=this.addNewOption(e)?e:t),t}afterInputReady(){super.afterInputReady(),"relation"===this.schema.type&&(this.newEnumAllowed=!0,this.control?.querySelector(".select2-container")?.removeAttribute("style"))}},window.JSONEditor.defaults.resolvers.unshift((function(e){if("relation"===e.type&&"select2"===e.format)return"select2"}));const t=document.querySelectorAll(".structured-field-editor");for(let s=0;s<t.length;s++)e(t[s])}))}();
