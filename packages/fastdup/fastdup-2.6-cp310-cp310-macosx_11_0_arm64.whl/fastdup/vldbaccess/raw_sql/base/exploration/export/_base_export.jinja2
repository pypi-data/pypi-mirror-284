WITH
{% include "_similarity_filtering_cte.jinja2" %},
media_context AS (
    SELECT
        flat_similarity_clusters.image_or_object_id,
        flat_similarity_clusters.image_id,
        flat_similarity_clusters.dataset_id,
        flat_similarity_clusters.image_uri,
        flat_similarity_clusters.original_uri,
        flat_similarity_clusters.metadata,
        flat_similarity_clusters.bounding_box,
        flat_similarity_clusters.cluster_type,
        flat_similarity_clusters.cluster_id
	FROM flat_similarity_clusters
    {% include "_similarity_join_filtering.jinja2" %}
	WHERE
        True
        {% include "_composite_filter.jinja2" %}
        {% if cluster_ids and media_ids %}
        AND (cluster_id = ANY(:cluster_ids) OR image_or_object_id = ANY(:media_ids))
        {% elif cluster_ids %}
        AND (cluster_id = ANY(:cluster_ids))
        {% elif media_ids %}
        AND (image_or_object_id = ANY(:media_ids))
        {% endif %}
)