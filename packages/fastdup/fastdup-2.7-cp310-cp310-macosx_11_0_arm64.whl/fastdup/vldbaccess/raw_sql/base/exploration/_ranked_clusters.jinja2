SELECT
flat_similarity_clusters.*,
{% if is_textual_search %}
    {% include "_text_img_relevance.jinja2" %} AS img_relevance,
{% endif %}
page_of_clusters.n_videos_filtered,
page_of_clusters.n_frames_filtered,
page_of_clusters.n_images_filtered,
page_of_clusters.n_objects_filtered,
page_of_clusters.cluster_rn,
--{% if similarity_using_vector_db and anchor_media_id and cosine_similarity %}
1 - (image_vector_filtered.similarity_distance_) as distance,
row_number() OVER (PARTITION BY flat_similarity_clusters.cluster_id ORDER BY (image_vector_filtered.similarity_distance_) DESC) as rn
--{% elif similarity_using_vector_db and anchor_media_id %}
image_vector_filtered.similarity_distance_ as distance,
row_number() OVER (PARTITION BY flat_similarity_clusters.cluster_id ORDER BY (image_vector_filtered.similarity_distance_) ASC) as rn
--{% elif anchor_media_id %}
1 - distance as distance,
row_number() OVER (PARTITION BY flat_similarity_clusters.cluster_id ORDER BY distance DESC) as rn
--{% else %}
row_number() OVER (PARTITION BY flat_similarity_clusters.cluster_id ORDER BY preview_order) as rn
--{% endif %}
FROM
    flat_similarity_clusters
JOIN
    page_of_clusters ON flat_similarity_clusters.cluster_id = page_of_clusters.cluster_id
    {% include "_similarity_join_filtering.jinja2" %}
WHERE
true
{% include "_composite_filter.jinja2" %}
ORDER BY
--{% if anchor_media_id %}
    distance ASC,
--{% elif is_textual_search %}
    img_relevance DESC,
--{% else %}
    formed_by,
    (n_images+n_objects) DESC,
    {% endif %}
flat_similarity_clusters.cluster_id,
preview_order
